name: Cleanup Expired Tokens

on:
  schedule:
    # Run every hour at :15 (e.g., 00:15, 01:15, 02:15)
    - cron: '15 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Expired File Access Tokens
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_PUBLISHABLE_KEY: ${{ secrets.SUPABASE_PUBLISHABLE_KEY }}
          EDGE_SECRET_KEY: ${{ secrets.EDGE_SECRET_KEY }}
        run: |
          # apikey header required for Supabase gateway routing
          # x-edge-secret header used for custom auth in the edge function
          RESPONSE=$(curl -s -w "\n%{http_code}" -L -X POST \
            -H "apikey: ${SUPABASE_PUBLISHABLE_KEY}" \
            -H "x-edge-secret: ${EDGE_SECRET_KEY}" \
            "${SUPABASE_URL}/functions/v1/cleanup-expired-tokens")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: HTTP $HTTP_CODE"
            exit 1
          fi

          # Extract deleted count from JSON response
          DELETED_COUNT=$(echo "$BODY" | jq -r '.deletedCount // 0')
          echo "Successfully cleaned up $DELETED_COUNT expired tokens"
