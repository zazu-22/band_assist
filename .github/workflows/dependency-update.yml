name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggers

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'

      - name: Check for updates
        id: check-updates
        run: |
          # Install npm-check-updates
          npm install -g npm-check-updates

          # Check for updates
          ncu -u --target minor > update_log.txt || true

          if git diff --quiet package.json; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates available"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates available:"
            cat update_log.txt
          fi

      - name: Install updated dependencies
        if: steps.check-updates.outputs.has_updates == 'true'
        run: npm install

      - name: Run tests
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          # Type check
          npx tsc --noEmit

          # Build to ensure everything works
          npm run build

      - name: Create Pull Request
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update dependencies'
          title: 'chore(deps): Weekly dependency updates'
          body: |
            ## ðŸ“¦ Dependency Updates

            This PR updates project dependencies to their latest minor versions.

            ### Changes
            ```
            $(cat update_log.txt)
            ```

            ### Verification
            - âœ… TypeScript compilation passed
            - âœ… Production build successful

            ### Notes
            - Only minor and patch updates are included (no major version bumps)
            - Please review the changes and test thoroughly before merging
            - Consider running manual tests if significant updates are included

            ---
            ðŸ¤– Auto-generated by dependency-update workflow
          branch: chore/dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated

  security-updates:
    name: Security Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'

      - name: Check for security vulnerabilities
        id: audit
        run: |
          # Run npm audit and capture output
          npm audit --json > audit.json || true

          # Check if there are fixable vulnerabilities
          FIXABLE=$(cat audit.json | grep -o '"fixAvailable":[^,]*' | grep -c 'true' || echo "0")
          echo "fixable=$FIXABLE" >> $GITHUB_OUTPUT

          if [ "$FIXABLE" -gt 0 ]; then
            echo "Found $FIXABLE fixable vulnerabilities"
            npm audit fix
          else
            echo "No fixable vulnerabilities found"
          fi

      - name: Create Security PR
        if: steps.audit.outputs.fixable != '0'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix(security): apply security updates'
          title: 'ðŸ”’ Security: Apply automated security fixes'
          body: |
            ## ðŸ”’ Security Updates

            This PR applies automated fixes for security vulnerabilities.

            ### Vulnerabilities Fixed
            Found and fixed **${{ steps.audit.outputs.fixable }}** vulnerabilities.

            See the full audit report:
            ```
            $(npm audit || true)
            ```

            ### Verification Required
            - Please review the changes carefully
            - Test the application thoroughly
            - Check for any breaking changes

            ---
            ðŸ¤– Auto-generated by security-update workflow
          branch: security/automated-fixes
          delete-branch: true
          labels: |
            security
            automated
            high-priority
