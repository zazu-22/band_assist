#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Conventional Commits validation
# Format: type(scope?): subject
# Examples:
#   feat: add new feature
#   fix: resolve bug in component
#   docs: update README
#   style: format code
#   refactor: restructure module
#   test: add unit tests
#   chore: update dependencies

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Skip validation for merge commits
if echo "$commit_msg" | grep -qE "^Merge "; then
  exit 0
fi

# Skip validation for revert commits
if echo "$commit_msg" | grep -qE "^Revert "; then
  exit 0
fi

# Validate conventional commit format
if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{3,}"; then
  echo "❌ Invalid commit message format!"
  echo ""
  echo "Commit messages must follow the Conventional Commits format:"
  echo "  type(scope?): subject"
  echo ""
  echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
  echo ""
  echo "Examples:"
  echo "  feat: add song export functionality"
  echo "  fix(player): resolve audio playback issue"
  echo "  docs: update deployment guide"
  echo ""
  exit 1
fi

# Check subject length
subject=$(echo "$commit_msg" | head -n1 | sed -E 's/^[a-z]+(\([^)]+\))?: //')
if [ ${#subject} -gt 72 ]; then
  echo "⚠️  Warning: Commit subject is longer than 72 characters (${#subject})"
fi

echo "✅ Commit message format is valid"
